CREATE PROC usp_DeleteEmployeesFromDepartment (@departmentId INT)
AS
DECLARE @empIDsToBeDeleted TABLE
(
	Id int
)
INSERT INTO @empIDsToBeDeleted
	 SELECT e.EmployeeID
	   FROM Employees AS e
	  WHERE e.DepartmentID = @departmentId

 ALTER TABLE Departments
ALTER COLUMN ManagerID int NULL

DELETE FROM EmployeesProjects
      WHERE EmployeeID IN (SELECT Id FROM @empIDsToBeDeleted)

UPDATE Employees
   SET ManagerID = NULL
 WHERE ManagerID IN (SELECT Id FROM @empIDsToBeDeleted)

UPDATE Departments
   SET ManagerID = NULL
 WHERE ManagerID IN (SELECT Id FROM @empIDsToBeDeleted)

DELETE FROM Employees
      WHERE EmployeeID IN (SELECT Id FROM @empIDsToBeDeleted)

DELETE FROM Departments
      WHERE DepartmentID = @departmentId 

    SELECT COUNT(*) AS [Employees Count]
	  FROM Employees AS e
INNER JOIN Departments AS d
		ON d.DepartmentID = e.DepartmentID
	 WHERE e.DepartmentID = @departmentId